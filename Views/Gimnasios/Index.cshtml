@{
ViewData["Title"] = "Gestión de Gimnasios";
}

<div class="container-fluid px-5 mb-5 pb-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bolder text-dark mb-2">Gimnasios</h1>
            <p class="text-muted mb-0">Gestiona todos los gimnasios registrados en el sistema</p>
        </div>
        <div class="d-flex gap-2">
            <button id="btnExportExcel" class="btn btn-success btn-sm">
                <i class="bi bi-file-earmark-excel me-2"></i>
                Exportar Excel
            </button>
            <a href="/Gimnasios/Crear" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle me-2"></i>
                Nuevo Gimnasio
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted fw-semibold d-block fs-7">Total Gimnasios</span>
                            <span class="text-dark fw-bolder fs-2" id="totalGimnasios">0</span>
                        </div>
                        <div class="bg-primary rounded-3 p-3">
                            <i class="bi bi-building text-white fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted fw-semibold d-block fs-7">Gimnasios Activos</span>
                            <span class="text-dark fw-bolder fs-2" id="gimnaiosActivos">0</span>
                        </div>
                        <div class="bg-success rounded-3 p-3">
                            <i class="bi bi-check-circle text-white fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted fw-semibold d-block fs-7">En Prueba</span>
                            <span class="text-dark fw-bolder fs-2" id="gimnasiosPrueba">0</span>
                        </div>
                        <div class="bg-warning rounded-3 p-3">
                            <i class="bi bi-clock-history text-white fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted fw-semibold d-block fs-7">Total Clientes</span>
                            <span class="text-dark fw-bolder fs-2" id="totalClientes">0</span>
                        </div>
                        <div class="bg-info rounded-3 p-3">
                            <i class="bi bi-people text-white fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 pt-5 pb-3">
            <h3 class="card-title fw-bold text-dark">Listado de Gimnasios</h3>
        </div>
        <div class="card-body pt-0">
            <table id="gimnasiosTable" class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                <thead>
                <tr class="fw-bold text-muted">
                    <th class="min-w-150px">Gimnasio</th>
                    <th class="min-w-140px">Dueño</th>
                    <th class="min-w-120px">Contacto</th>
                    <th class="min-w-100px">Clientes</th>
                    <th class="min-w-100px">Estado</th>
                    <th class="min-w-100px">Tipo</th>
                    <th class="min-w-120px">Fecha Creación</th>
                    <th class="min-w-100px text-end">Acciones</th>
                </tr>
                </thead>
                <tbody class="text-gray-600 fw-semibold">
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Modal Editar Gimnasio -->
<div class="modal fade" id="editarGimnasioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h3 class="modal-title fw-bolder">
                    <i class="bi bi-pencil-square text-primary me-2"></i>
                    Editar Gimnasio
                </h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="editarGimnasioForm">
                    <input type="hidden" id="editGimnasioId" name="GimnasioId" />

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-semibold required">Nombre del Gimnasio</label>
                            <input type="text" class="form-control form-control-lg" name="GimnasioNombre" id="editGimnasioNombre" required />
                        </div>

                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-semibold required">Nombre del Dueño</label>
                            <input type="text" class="form-control form-control-lg" name="DuenoGimnasio" id="editDuenoGimnasio" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-semibold required">Email</label>
                            <input type="email" class="form-control form-control-lg" name="Email" id="editEmail" required />
                        </div>

                        <div class="col-md-6 mb-4">
                            <label class="form-label fw-semibold required">Teléfono</label>
                            <input type="tel" class="form-control form-control-lg" name="Telefono" id="editTelefono" required />
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Contraseña</label>
                        <input type="password" class="form-control form-control-lg" name="Password" id="editPassword" />
                        <div class="form-text">Dejar en blanco para mantener la contraseña actual</div>
                    </div>

                    <!-- Reemplazar los dos checkboxes en el modal por esto: -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold required">Tipo de Gimnasio</label>
                        <div class="d-flex gap-3 mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoGimnasioEdit"
                                       id="editTipoPago" value="pago" />
                                <label class="form-check-label" for="editTipoPago">
                                    <i class="bi bi-credit-card text-primary me-1"></i>
                                    De Pago (Activo)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoGimnasioEdit"
                                       id="editTipoPrueba" value="prueba" />
                                <label class="form-check-label" for="editTipoPrueba">
                                    <i class="bi bi-clock-history text-warning me-1"></i>
                                    De Prueba
                                </label>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" id="btnGuardarEdicion" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>
                    Guardar Cambios
                </button>
            </div>

        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="eliminarGimnasioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bolder">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-trash text-danger" style="font-size: 4rem;"></i>
                <h4 class="mt-3">¿Estás seguro?</h4>
                <p class="text-muted mb-0">
                    Vas a eliminar el gimnasio <strong id="deleteGimnasioNombre"></strong>
                </p>
                <p class="text-danger fw-semibold">Esta acción no se puede deshacer.</p>
                <input type="hidden" id="deleteGimnasioId" />
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" id="btnConfirmarEliminar" class="btn btn-danger">
                    <i class="bi bi-trash me-2"></i>
                    Sí, Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let tablaGimnasios;

    $(document).ready(function () {
        cargarTabla();
    });

    function cargarTabla() {
        tablaGimnasios = $('#gimnasiosTable').DataTable({
            ajax: {
                url: '/Gimnasios/GetGimnasios',
                type: 'GET',
                dataSrc: function(data) {
                    actualizarEstadisticas(data);
                    return data;
                }
            },
            columns: [
                {
                    data: 'gimnasioNombre',
                    render: function(data, type, row) {
                        return `
                                <div class="d-flex align-items-center">
                                    <div class="symbol symbol-45px me-3">
                                        <div class="symbol-label bg-light-primary">
                                            <i class="bi bi-building text-primary fs-3"></i>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-start flex-column">
                                        <span class="text-dark fw-bold fs-6">${data}</span>
                                        <span class="text-muted fw-semibold text-muted d-block fs-7">ID: ${row.gimnasioId.substring(0, 8)}</span>
                                    </div>
                                </div>
                            `;
                    }
                },
                {
                    data: 'duenoGimnasio',
                    render: function(data) {
                        return `<span class="text-dark fw-semibold">${data || 'N/A'}</span>`;
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                                <div class="d-flex flex-column">
                                    <span class="text-dark fw-semibold mb-1">
                                        <i class="bi bi-envelope me-1 text-muted"></i>${row.email}
                                    </span>
                                    <span class="text-muted fw-semibold">
                                        <i class="bi bi-telephone me-1"></i>${row.telefono}
                                    </span>
                                </div>
                            `;
                    }
                },
                {
                    data: 'totalClientes',
                    render: function(data) {
                        return `<span class="badge badge-light-info fs-7 fw-bold">${data} cliente${data !== 1 ? 's' : ''}</span>`;
                    }
                },
                {
                    data: 'isActive',
                    render: function(data, type, row) {
                        if(data) {
                            return '<span class="badge badge-light-success">Activo</span>';
                        } else {
                            return '<span class="badge badge-light-danger">Inactivo</span>';
                        }
                    }
                },
                {
                    data: 'esPrueba',
                    render: function(data) {
                        if(data) {
                            return '<span class="badge badge-light-warning">Prueba</span>';
                        } else {
                            return '<span class="badge badge-light-primary">Pago</span>';
                        }
                    }
                },
                {
                    data: 'fechaCreacion',
                    render: function(data) {
                        if (data) {
                            const fecha = new Date(data);
                            return `<span class="text-muted fw-semibold">${fecha.toLocaleDateString('es-ES')}</span>`;
                        }
                        return '<span class="text-muted">N/A</span>';
                    }
                },
                {
                    data: null,
                    orderable: false,
                    className: 'text-end',
                    render: function(data, type, row) {
                        const estadoBtn = row.isActive
                            ? `<button class="btn btn-icon btn-bg-light btn-sm me-1" onclick="cambiarEstado('${row.gimnasioId}')" title="Desactivar">
                                     <i class="bi bi-toggle-on text-success fs-4"></i>
                                   </button>`
                            : `<button class="btn btn-icon btn-bg-light btn-sm me-1" onclick="cambiarEstado('${row.gimnasioId}')" title="Activar">
                                     <i class="bi bi-toggle-off text-danger fs-4"></i>
                                   </button>`;

                        return `
                                <div class="d-flex justify-content-end gap-1">
                                    ${estadoBtn}
                                    <button class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm me-1" onclick="editarGimnasio('${row.gimnasioId}')" title="Editar">
                                        <i class="bi bi-pencil fs-5"></i>
                                    </button>
                                    <button class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm" onclick="confirmarEliminar('${row.gimnasioId}', '${row.gimnasioNombre}')" title="Eliminar">
                                        <i class="bi bi-trash fs-5"></i>
                                    </button>
                                </div>
                            `;
                    }
                }
            ],
            order: [[0, 'asc']],
            language: {
                url: '//cdn.datatables.net/plug-ins/2.3.6/i18n/es-ES.json'
            },
            responsive: true,
            pageLength: 10
        });
    }

    function actualizarEstadisticas(data) {
        const total = data.length;
        const activos = data.filter(g => g.isActive).length;
        const prueba = data.filter(g => g.esPrueba).length;
        const totalClientesSum = data.reduce((sum, g) => sum + g.totalClientes, 0);

        $('#totalGimnasios').text(total);
        $('#gimnaiosActivos').text(activos);
        $('#gimnasiosPrueba').text(prueba);
        $('#totalClientes').text(totalClientesSum);
    }

    // Editar Gimnasio
    function editarGimnasio(id) {
        $.ajax({
            url: '/Gimnasios/GetGimnasio/' + id,
            type: 'GET',
            success: function (data) {
                $('#editGimnasioId').val(data.gimnasioId);
                $('#editGimnasioNombre').val(data.gimnasioNombre);
                $('#editDuenoGimnasio').val(data.duenoGimnasio);
                $('#editEmail').val(data.email);
                $('#editTelefono').val(data.telefono);
                $('#editPassword').val('');

                // Seleccionar el radio correcto según la lógica de negocio
                if (data.isActive) {
                    $('#editTipoPago').prop('checked', true);
                } else {
                    $('#editTipoPrueba').prop('checked', true);
                }

                $('#editarGimnasioModal').modal('show');
            },
            error: function () {
                toastr.error('Error al cargar los datos del gimnasio');
            }
        });
    }

    // Guardar Edición - SOLO UNA VEZ
    $('#btnGuardarEdicion').click(function () {
        if (!$('#editarGimnasioForm')[0].checkValidity()) {
            $('#editarGimnasioForm')[0].reportValidity();
            return;
        }

        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Guardando...');

        const tipoGimnasio = $('input[name="tipoGimnasioEdit"]:checked').val();

        const formData = {
            GimnasioId: $('#editGimnasioId').val(),
            GimnasioNombre: $('#editGimnasioNombre').val(),
            DuenoGimnasio: $('#editDuenoGimnasio').val(),
            Email: $('#editEmail').val(),
            Telefono: $('#editTelefono').val(),
            Password: $('#editPassword').val(),
            IsActive: tipoGimnasio === 'pago',
            EsPrueba: tipoGimnasio === 'prueba'
        };

        $.ajax({
            url: '/Gimnasios/Editar',
            type: 'POST',
            data: formData,
            success: function (response) {
                if (response.success) {
                    $('#editarGimnasioModal').modal('hide');
                    tablaGimnasios.ajax.reload(null, false);
                    toastr.success(response.message);
                } else {
                    toastr.error(response.message);
                }
                btn.prop('disabled', false).html('<i class="bi bi-save me-2"></i>Guardar Cambios');
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                toastr.error(response?.message || 'Error al guardar el gimnasio');
                btn.prop('disabled', false).html('<i class="bi bi-save me-2"></i>Guardar Cambios');
            }
        });
    });

    // Confirmar Eliminar (abrir modal)
    function confirmarEliminar(id, nombre) {
        $('#deleteGimnasioId').val(id);
        $('#deleteGimnasioNombre').text(nombre);
        $('#eliminarGimnasioModal').modal('show');
    }

    // Ejecutar Eliminación
    $('#btnConfirmarEliminar').click(function() {
        const id = $('#deleteGimnasioId').val();
        const btn = $(this);

        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...');

        $.ajax({
            url: '/Gimnasios/Eliminar',
            type: 'POST',
            data: { id: id },
            success: function (response) {
                if (response.success) {
                    $('#eliminarGimnasioModal').modal('hide');
                    tablaGimnasios.ajax.reload(null, false);
                    toastr.success(response.message);
                } else {
                    toastr.error(response.message);
                }
                btn.prop('disabled', false).html('<i class="bi bi-trash me-2"></i>Sí, Eliminar');
            },
            error: function (xhr) {
                const response = xhr.responseJSON;
                toastr.error(response?.message || 'Error al eliminar el gimnasio');
                btn.prop('disabled', false).html('<i class="bi bi-trash me-2"></i>Sí, Eliminar');
            }
        });
    });

    // Cambiar Estado
    function cambiarEstado(id) {
        $.ajax({
            url: '/Gimnasios/CambiarEstado',
            type: 'POST',
            data: { id: id },
            success: function (response) {
                if (response.success) {
                    tablaGimnasios.ajax.reload(null, false);
                    toastr.success(response.message);
                }
            },
            error: function () {
                toastr.error('Error al cambiar el estado');
            }
        });
    }

    // Exportar Excel
    $('#btnExportExcel').click(function () {
        window.location.href = '/Gimnasios/ExportExcel';
    });
</script>

<style>
    .bg-light-primary { background-color: rgba(13, 110, 253, 0.1); }
    .bg-light-success { background-color: rgba(25, 135, 84, 0.1); }
    .bg-light-warning { background-color: rgba(255, 193, 7, 0.1); }
    .bg-light-info { background-color: rgba(13, 202, 240, 0.1); }
    .bg-light-danger { background-color: rgba(220, 53, 69, 0.1); }

    .badge-light-primary { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    .badge-light-success { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
    .badge-light-warning { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
    .badge-light-info { background-color: rgba(13, 202, 240, 0.1); color: #0dcaf0; }
    .badge-light-danger { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }

    .required:after {
        content: " *";
        color: #dc3545;
    }

    .symbol {
        display: inline-block;
        flex-shrink: 0;
        position: relative;
        border-radius: 0.475rem;
    }

    .symbol-label {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .symbol-45px .symbol-label {
        width: 45px;
        height: 45px;
    }

    .fs-7 { font-size: 0.85rem; }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .btn-icon {
        width: 35px;
        height: 35px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .form-check-custom .form-check-input {
        width: 2.75rem;
        height: 1.5rem;
    }
</style>
}